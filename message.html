<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miner Co ‚Äî Enhanced++</title>
  <style>
    /* ============ THEME ============ */
    :root {
      --bg: #0b1726;
      --bg-2: #0f2238;
      --panel: rgba(255,255,255,0.08);
      --panel-2: rgba(255,255,255,0.14);
      --text: #e6eef7;
      --muted: #9fb3c8;

      --accent: #2de37a;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;

      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, #132742 0%, var(--bg) 50%) no-repeat,
                  radial-gradient(1200px 600px at 80% 100%, #12233a 0%, var(--bg) 50%) no-repeat,
                  linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      overflow-x: hidden;
    }

    [data-motion="off"] *, [data-motion="off"] .shine:before { animation: none !important; transition: none !important; }

    /* Ambient orbs */
    .orb { position: fixed; pointer-events: none; width: 280px; height: 280px; border-radius: 50%; filter: blur(50px); opacity: 0.15; z-index: 0; animation: float 18s ease-in-out infinite; }
    .orb.one { background: #22c55e; top: 5%; left: -60px; }
    .orb.two { background: #60a5fa; bottom: -60px; right: -60px; animation-delay: 4s; }
    @keyframes float { 0%,100% { transform: translateY(0) translateX(0) scale(1); } 50% { transform: translateY(-25px) translateX(15px) scale(1.05); } }

    /* ============ HEADER ============ */
    header { position: sticky; top: 0; z-index: 5; backdrop-filter: saturate(1.2) blur(8px); background: linear-gradient(180deg, rgba(16,30,49,0.75) 0%, rgba(16,30,49,0.35) 100%); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .title { display: flex; align-items: center; justify-content: space-between; gap: 16px; }
    .title h1 { margin: 0; font-size: clamp(1.4rem, 2.4vw, 2rem); letter-spacing: 0.5px; }
    .badges { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 999px; font-size: 13px; color: var(--muted); }
    .badge .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 3px rgba(34,197,94,0.25); }

    /* Powerup bars */
    #powerupBars { display: grid; gap: 6px; padding: 0 16px 10px; }
    .bar { height: 8px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; }
    .bar-fill { height: 100%; width: 0; background: linear-gradient(90deg, #22c55e, #60a5fa); }

    /* ============ LOGIN ============ */
    #login-container { max-width: 560px; margin: 40px auto; padding: 20px; background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); box-shadow: var(--shadow); transform-origin: top center; animation: drop 600ms cubic-bezier(.2,.8,.2,1); }
    @keyframes drop { from { opacity: 0; transform: translateY(-10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    input[type="text"], input[type="password"], input[type="number"], input[type="file"] { flex: 1 1 220px; padding: 12px 14px; border-radius: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: var(--text); outline: none; transition: border 120ms ease, box-shadow 120ms ease; }
    input::placeholder { color: #9db2c7; }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(34,197,94,0.15); }

    button { appearance: none; border: 0; cursor: pointer; color: #08121e; background: linear-gradient(180deg, #3cf191, #1acb63); padding: 12px 18px; border-radius: 12px; font-weight: 700; letter-spacing: .2px; transition: transform 80ms ease, filter 80ms ease; user-select: none; }
    button:hover { filter: brightness(1.03); }
    button:active { transform: translateY(1px) scale(0.99); }

    .btn-ghost { background: rgba(255,255,255,0.06); color: var(--text); border: 1px solid rgba(255,255,255,0.12); }
    .btn-danger { background: linear-gradient(180deg, #ff6b6b, #ef4444); color: #120909; }

    /* ============ CONTROLS/MENUS ============ */
    #controls { display: none; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 14px auto 6px; }
    #controls .btn { background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 12px; font-weight: 600; }

    .menus { max-width: 1100px; margin: 6px auto; padding: 0 16px; }
    .menu { display: none; margin: 14px 0; padding: 14px; border-radius: var(--radius); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.1); box-shadow: var(--shadow); transform-origin: top center; }
    .menu.show { display: block; animation: menuIn 260ms cubic-bezier(.2,.8,.2,1); }
    .menu.hide { animation: menuOut 200ms ease forwards; }
    @keyframes menuIn { from { opacity:0; transform: translateY(-6px) scale(.98);} to {opacity:1; transform: translateY(0) scale(1);} }
    @keyframes menuOut { to { opacity:0; transform: translateY(-6px) scale(.98);} }

    .menu h3 { margin: 6px 6px 14px; font-size: 1rem; color: var(--muted); font-weight: 700; letter-spacing: .3px; }
    .grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

    .card { background: var(--panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 12px; transition: transform 120ms ease, box-shadow 120ms ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.25); }

    /* ============ MINE GRID ============ */
    #mine { position: relative; z-index: 1; max-width: 1100px; margin: 18px auto 12px; padding: 0 16px; }
    .mine-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); }

    .ore { position: relative; overflow: hidden; cursor: pointer; user-select: none; padding: 18px 12px; border-radius: 16px; text-align: center; color: #08121e; font-weight: 800; letter-spacing: .3px; text-shadow: 0 1px 0 rgba(255,255,255,0.35); box-shadow: 0 4px 20px rgba(0,0,0,0.25); transform: translateZ(0); transition: transform 80ms ease; }
    .ore:hover { transform: translateY(-2px) scale(1.01); }
    .ore:active { transform: translateY(0) scale(0.99); }
    .ore .sub { display:block; font-size: 12px; font-weight: 700; opacity: .9; }

    .shine:before { content: ""; position: absolute; inset: -150% -50% auto auto; height: 200%; width: 40%; background: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 70%); transform: translateX(-120%) rotate(20deg); animation: shimmer 2.6s infinite; mix-blend-mode: soft-light; }
    @keyframes shimmer { to { transform: translateX(180%) rotate(20deg); } }

    .ore.coal { background: linear-gradient(180deg,#bdbdbd,#8b8b8b); }
    .ore.copper { background: linear-gradient(180deg,#f59e0b,#b45309); }
    .ore.bronze { background: linear-gradient(180deg,#eab308,#a16207); }
    .ore.silver { background: linear-gradient(180deg,#f3f4f6,#a7aab2); }
    .ore.gold { background: linear-gradient(180deg,#fde047,#eab308); }
    .ore.diamond { background: linear-gradient(180deg,#93c5fd,#60a5fa); }
    .ore.emerald { background: linear-gradient(180deg,#34d399,#10b981); }
    .ore.rainbow { background: conic-gradient(from 0deg, #ef4444, #f59e0b, #eab308, #22c55e, #60a5fa, #a855f7, #ef4444); color:#0a0a0a; }
    .ore.goldrush { background: repeating-linear-gradient(135deg, #facc15 0 14px, #f59e0b 14px 28px); }

    .lock { position: absolute; right: 8px; top: 8px; font-size: 12px; color: rgba(0,0,0,0.65); background: rgba(255,255,255,0.5); padding: 3px 6px; border-radius: 999px; font-weight: 900; }

    /* Inventory bar */
    #inventoryBar { position: sticky; bottom: 0; z-index: 5; background: linear-gradient(180deg, rgba(16,30,49,0.45) 0%, rgba(16,30,49,0.9) 100%); border-top: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(8px) saturate(1.1); padding: 10px 16px; }
    .inv { max-width: 1100px; margin: 0 auto; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .inv-left, .inv-right { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .pill { display: inline-flex; align-items:center; gap: 8px; padding: 8px 10px; border-radius: 999px; background: var(--panel); border: 1px solid rgba(255,255,255,0.1); }
    .pill b { font-variant-numeric: tabular-nums; }

    .sell { padding: 10px 14px; }

    /* Toasts */
    #toasts { position: fixed; right: 16px; bottom: 90px; display: grid; gap: 8px; z-index: 10; }
    .toast { background: var(--panel-2); border: 1px solid rgba(255,255,255,0.14); color: var(--text); padding: 10px 12px; border-radius: 12px; box-shadow: var(--shadow); animation: toastIn 200ms ease; }
    @keyframes toastIn { from {opacity:0; transform: translateY(6px);} to {opacity:1; transform: translateY(0);} }

    /* Floating text */
    .float { position: fixed; pointer-events: none; z-index: 9; font-weight: 900; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.4); animation: floatUp 700ms ease forwards; }
    @keyframes floatUp { to { transform: translateY(-30px); opacity: 0; } }

    /* Particles */
    .particle { position: fixed; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; opacity: .9; animation: explode 600ms ease forwards; }
    @keyframes explode { to { transform: translate(var(--dx), var(--dy)) scale(0.2); opacity: 0; } }

    /* Event banner */
    #eventBanner { position: sticky; top: 0; z-index: 6; display: none; }
    .banner { margin: 0 auto; max-width: 1100px; padding: 8px 14px; border-radius: 12px; background: linear-gradient(90deg, #f59e0b, #22c55e, #60a5fa); color: #0b1220; font-weight: 900; letter-spacing: .3px; text-align: center; animation: slideIn 240ms ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-8px);} to { opacity: 1; transform: translateY(0);} }

    /* Helpers */
    .muted { color: var(--muted); }
    .center { text-align: center; }
    .hidden { display: none !important; }

    /* Accessibility focus */
    :focus-visible { outline: 3px solid rgba(34,197,94,0.6); outline-offset: 3px; border-radius: 10px; }
  </style>
</head>
<body>
  <div class="orb one"></div>
  <div class="orb two"></div>

  <header>
    <div class="wrap title">
      <h1 id="title">Welcome to Miner Co</h1>
      <div class="badges">
        <span class="badge" id="pickaxeBadge"><span class="dot"></span> Pickaxe: <b id="pickaxeLabel">-</b></span>
        <span class="badge" id="silverBadge">ü™ô Silver: <b id="silverLabel">0</b></span>
        <span class="badge" id="powerupBadge" title="Active powerups will appear below.">‚ö° Powerups: <b id="powerupLabel">none</b></span>
      </div>
    </div>
    <div id="powerupBars" class="wrap" style="padding-top:0"></div>
  </header>

  <main class="wrap">
    <div id="login-container" aria-live="polite">
      <div class="center" style="margin-bottom:10px">
        <h2 style="margin:6px 0">Sign in to start mining</h2>
        <p class="muted" style="margin:0">New players: just pick a name and password to create.</p>
      </div>
      <div class="row" style="margin-top:10px">
        <input type="text" id="username" placeholder="Enter Username" autocomplete="username" />
        <input type="password" id="password" placeholder="Enter Password" autocomplete="current-password" />
        <button id="loginBtn">Login / Create</button>
      </div>
    </div>

    <div id="controls" class="row" role="toolbar" aria-label="Game controls">
      <button class="btn" onclick="toggleMenu('shopMenu')">1Ô∏è‚É£ ü™ì Shop</button>
      <button class="btn" onclick="toggleMenu('powerupMenu')">2Ô∏è‚É£ ‚ö° Powerups</button>
      <button class="btn" onclick="toggleMenu('petShopMenu')">3Ô∏è‚É£ üêæ Pets</button>
      <button class="btn" onclick="toggleMenu('gearShopMenu')">4Ô∏è‚É£ ‚öîÔ∏è Gear</button>
      <button class="btn" onclick="toggleMenu('codeMenu')">5Ô∏è‚É£ üîì Codes</button>
      <button class="btn" onclick="toggleMenu('adminMenu')">6Ô∏è‚É£ ‚öôÔ∏è Admin</button>
      <button class="btn" onclick="toggleMenu('leaderboardMenu')">7Ô∏è‚É£ üèÜ Leaderboard</button>
      <button class="btn" onclick="toggleMenu('achievementsMenu')">8Ô∏è‚É£ üèÖ Achievements</button>
      <button class="btn" onclick="toggleMenu('settingsMenu')">9Ô∏è‚É£ ‚öôÔ∏è Settings</button>
      <button class="btn" id="dailyBtn">üéÅ Daily</button>
    </div>

    <div id="eventBanner"></div>

    <section id="mine"></section>

    <section class="menus">
      <div id="shopMenu" class="menu">
        <h3>ü™ì Pickaxe Shop</h3>
        <div id="shopGrid" class="grid"></div>
      </div>

      <div id="powerupMenu" class="menu">
        <h3>‚ö° Powerups</h3>
        <div id="powerupGrid" class="grid"></div>
      </div>

      <div id="petShopMenu" class="menu">
        <h3>üêæ Pet Gacha</h3>
        <p class="muted">Spin for <b>150 Silver</b>. Pets give passive bonuses. Duplicates refund <b>50</b> Silver.</p>
        <button id="spinPetBtn">üéÅ Spin Pet</button>
        <div id="petResult" class="grid" style="margin-top:10px"></div>
        <div id="petsOwned" class="grid" style="margin-top:10px"></div>
      </div>

      <div id="gearShopMenu" class="menu">
        <h3>‚öîÔ∏è Gear</h3>
        <p class="muted">Swords grant a chance to <b>crit</b> (double yield).</p>
        <div id="gearGrid" class="grid"></div>
      </div>

      <div id="codeMenu" class="menu">
        <h3>üîì Codes</h3>
        <div class="row">
          <input type="text" id="codeInput" placeholder="Enter Code" />
          <button id="redeemBtn">Redeem</button>
        </div>
        <div id="codeMessage" class="muted" style="margin-top:8px"></div>
      </div>

      <div id="adminMenu" class="menu">
        <h3>‚öôÔ∏è Admin</h3>
        <div class="row">
          <input type="password" id="adminCode" placeholder="Admin Code" />
          <button id="adminLoginBtn">Login</button>
          <button class="btn-ghost" id="logoutBtn" title="Log out current player">Logout</button>
        </div>
        <div id="adminControls" class="row hidden" style="margin-top:10px">
          <button onclick="giveMoney()">üí∞ Infinite Money</button>
          <button onclick="givePowerups()">‚ö° All Powerups</button>
          <button onclick="spawnEvent('emerald')">üíö Emerald Event</button>
          <button onclick="spawnEvent('gold')">üü° Gold Rush</button>
          <button onclick="spawnEvent('rainbow')">üåà Rainbow Ores</button>
        </div>
      </div>

      <div id="leaderboardMenu" class="menu">
        <h3>üèÜ Leaderboard (Top by Silver)</h3>
        <ul id="leaderboardList"></ul>
      </div>

      <div id="achievementsMenu" class="menu">
        <h3>üèÖ Achievements</h3>
        <ul id="achievementsList"></ul>
      </div>

      <div id="settingsMenu" class="menu">
        <h3>‚öôÔ∏è Settings</h3>
        <div class="grid">
          <div class="card">
            <h4 style="margin:0 0 6px">Audio</h4>
            <div class="row">
              <button id="toggleSfxBtn"></button>
            </div>
          </div>
          <div class="card">
            <h4 style="margin:0 0 6px">Particles</h4>
            <div class="row">
              <label class="muted">Intensity: <b id="particleVal">1.0</b></label>
              <input type="range" id="particleRange" min="0" max="2" step="0.25" value="1" />
            </div>
          </div>
          <div class="card">
            <h4 style="margin:0 0 6px">Accessibility</h4>
            <div class="row">
              <button id="toggleMotionBtn"></button>
              <button id="toggleAutosellBtn"></button>
            </div>
            <p class="muted" style="margin-top:8px">Autosell commons (coal/copper/bronze) immediately converts to silver.</p>
          </div>
          <div class="card">
            <h4 style="margin:0 0 6px">Save Data</h4>
            <div class="row">
              <button id="exportBtn">Export Save</button>
              <label class="btn-ghost" for="importFile" style="padding: 12px 18px;">Import Save</label>
              <input id="importFile" type="file" accept="application/json" class="hidden" />
              <button id="copyBtn" class="btn-ghost">Copy to Clipboard</button>
            </div>
          </div>
          <div class="card">
            <h4 style="margin:0 0 6px">Shortcuts</h4>
            <p class="muted">1‚Äì9 open menus ¬∑ <b>X</b> Sell All ¬∑ <b>D</b> Daily</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="inventoryBar">
    <div class="inv">
      <div class="inv-left" id="inventoryLeft"></div>
      <div class="inv-right">
        <button class="sell" id="sellAllBtn">Sell All (X)</button>
      </div>
    </div>
  </div>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Audio -->
  <audio id="mineSound" src="https://www.soundjay.com/button/button-29.mp3" preload="auto"></audio>
  <audio id="munchSound" src="https://www.soundjay.com/human/chewing-01.mp3" preload="auto"></audio>

  <script>
    /* ================== DATA ================== */
    const ORES = ["coal","copper","bronze","silver","gold","diamond","emerald","rainbow","goldrush"];
    const ORE_REQUIREMENTS = { coal:"coal", copper:"copper", bronze:"bronze", silver:"silver", gold:"gold", diamond:"diamond", emerald:"emerald", rainbow:"diamond", goldrush:"diamond" };
    const PICKAXE_COSTS = { coal:{ coal:10 }, copper:{ coal:20 }, bronze:{ copper:30 }, silver:{ bronze:40 }, gold:{ silver:50 }, diamond:{ gold:60 }, emerald:{ diamond:100 } };
    const POWERUP_SHOP = { "2x Strength": 50, "2x Luck": 75 };
    const POWERUP_EFFECTS = { "2x Strength": { key:"strength", mult:2, secs:120 }, "2x Luck": { key:"luck", mult:2, secs:120 } };
    const ORE_VALUES = { coal:1, copper:2, bronze:3, silver:5, gold:8, diamond:15, emerald:30, rainbow:20, goldrush:0 };

    const SWORDS = [
      { id:"none", name:"No Sword", price:0, crit:0 },
      { id:"iron", name:"Iron Sword", price:80, crit:5 },
      { id:"steel", name:"Steel Sword", price:200, crit:12 },
      { id:"mythril", name:"Mythril Sword", price:500, crit:20 }
    ];

    const PET_POOL = [
      { id:"mole", name:"Mole", rarity:"common", effect:{ strength:1.25 } },
      { id:"cat", name:"Lucky Cat", rarity:"rare", effect:{ luck:1.5 } },
      { id:"parrot", name:"Parrot", rarity:"uncommon", effect:{ sell:1.1 } },
      { id:"fox", name:"Amber Fox", rarity:"epic", effect:{ crit:0.08 } },
      { id:"tortoise", name:"Tortoise", rarity:"common", effect:{ sustain:1 } }
    ];
    const PET_WEIGHTS = { common: 56, uncommon: 24, rare: 14, epic: 6 };

    const CODE_REWARDS = {
      WELCOME: _=>({ silver:200, message:"Welcome bonus: +200 Silver" }),
      LUCKY: _=>({ powerup:"2x Luck", message:"+2x Luck (120s)" }),
      SHINY: _=>({ item:{ diamond:5 }, message:"Diamonds x5" }),
      FREEPET: _=>({ freepet:true, message:"Free pet spin" }),
      GOLDRUSH: _=>({ event:"gold", message:"Gold Rush for 3 min!" })
    };

    const ACHIEVEMENTS = [
      { id:'first_gold', name:'First Gold', cond: p=> p.stats.total.gold>=1, reward:{ silver:50 } },
      { id:'first_diamond', name:'First Diamond', cond: p=> p.stats.total.diamond>=1, reward:{ silver:120 } },
      { id:'miner_100', name:'100 Ores', cond: p=> p.stats.oresMined>=100, reward:{ powerup:'2x Strength' } },
      { id:'miner_500', name:'500 Ores', cond: p=> p.stats.oresMined>=500, reward:{ silver:400 } },
      { id:'rich_1000', name:'1,000 Silver Earned', cond: p=> p.stats.silverEarned>=1000, reward:{ powerup:'2x Luck' } },
      { id:'smith_set', name:'Diamond Pickaxe', cond: p=> p.pickaxe==='diamond' || p.pickaxe==='emerald', reward:{ silver:200 } }
    ];

    const DEFAULT_PLAYER = () => ({
      username: "",
      inventory: { coal: 10, copper: 0, bronze: 0, silver: 0, gold: 0, diamond: 0, emerald: 0, rainbow: 0, goldrush: 0 },
      pickaxe: "coal",
      activePowerups: {},
      pets: [],
      silver: 0,
      sword: "none",
      usedCodes: [],
      mineSize: 24,
      settings: { sfx:true, particles:1, reducedMotion:false, autosell:false },
      stats: { oresMined:0, crits:0, silverEarned:0, silverSpent:0, total: { coal:0, copper:0, bronze:0, silver:0, gold:0, diamond:0, emerald:0, rainbow:0 } },
      achievementsUnlocked: [],
      lastDaily: 0
    });

    const state = { player: DEFAULT_PLAYER(), users: {}, event: null };

    const tierIndex = ore => ORES.indexOf(ore);

    /* ================== UTILITIES ================== */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = n => Number(n||0).toLocaleString();

    function toast(msg) { const box = document.createElement('div'); box.className = 'toast'; box.textContent = msg; $('#toasts').appendChild(box); setTimeout(()=> box.remove(), 2600); }

    function floatingText(text, x, y) { const el = document.createElement('div'); el.className = 'float'; el.textContent = text; el.style.left = x + 'px'; el.style.top = y + 'px'; document.body.appendChild(el); setTimeout(()=> el.remove(), 750); }

    function particles(x, y, baseColor='#fff', mult=1) {
      const count = Math.round(10 * (state.player.settings?.particles ?? 1) * mult);
      for (let i=0;i<count;i++) { const p = document.createElement('div'); p.className = 'particle'; const angle = Math.random()*Math.PI*2; const dist = 30 + Math.random()*40; p.style.setProperty('--dx', Math.cos(angle)*dist+'px'); p.style.setProperty('--dy', Math.sin(angle)*dist+'px'); p.style.left = x+'px'; p.style.top = y+'px'; p.style.background = baseColor; document.body.appendChild(p); setTimeout(()=> p.remove(), 620); }
    }

    function confetti(x, y) { const colors = ['#f59e0b','#ef4444','#10b981','#60a5fa','#a855f7']; const count = Math.round(24 * (state.player.settings?.particles ?? 1)); for (let i=0;i<count;i++) { const p = document.createElement('div'); p.className = 'particle'; const a = Math.random()*Math.PI*2; const d = 60 + Math.random()*80; p.style.setProperty('--dx', Math.cos(a)*d+'px'); p.style.setProperty('--dy', Math.sin(a)*d+'px'); p.style.width = p.style.height = (6+Math.random()*6)+'px'; p.style.borderRadius = Math.random()<0.5? '2px':'50%'; p.style.left = x+'px'; p.style.top = y+'px'; p.style.background = colors[i % colors.length]; document.body.appendChild(p); setTimeout(()=> p.remove(), 900); } }

    const now = () => Date.now();
    const isActive = k => state.player.activePowerups[k]?.until > now();

    function powerMult(key) {
      let m = (state.player.activePowerups[key] && isActive(key)) ? state.player.activePowerups[key].mult : 1;
      if (key==='strength') state.player.pets.forEach(pt=> m *= (pt.effect.strength || 1));
      if (key==='luck') state.player.pets.forEach(pt=> m *= (pt.effect.luck || 1));
      return m;
    }
    const sellMult = () => state.player.pets.reduce((m,pt)=> m*(pt.effect.sell||1), 1);
    function critChance() { const sword = SWORDS.find(s=> s.id===state.player.sword) || SWORDS[0]; let chance = sword.crit || 0; state.player.pets.forEach(pt=> chance += (pt.effect.crit || 0)*100); return chance; }

    function save() {
      try { const users = JSON.parse(localStorage.getItem('users')||'{}'); users[state.player.username] = state.player; localStorage.setItem('users', JSON.stringify(users)); } catch(e) { console.error('Save failed', e); }
    }
    function loadUsers() { try { state.users = JSON.parse(localStorage.getItem('users')||'{}'); } catch(_) { state.users = {}; } }

    /* ================== LOGIN ================== */
    function login() {
      const user = $('#username').value.trim();
      const pass = $('#password').value.trim();
      if (!user || !pass) { alert('Enter username & password'); return; }
      loadUsers();
      const existing = state.users[user] || DEFAULT_PLAYER();
      state.users[user] = { ...DEFAULT_PLAYER(), ...existing, username: user, // ensure new fields
        settings: { ...DEFAULT_PLAYER().settings, ...(existing.settings||{}) },
        stats: { ...DEFAULT_PLAYER().stats, ...(existing.stats||{}), total: { ...DEFAULT_PLAYER().stats.total, ...(existing.stats?.total||{}) } },
        activePowerups: existing.activePowerups||{} };
      state.player = state.users[user];
      localStorage.setItem('users', JSON.stringify(state.users));

      $('#login-container').classList.add('hidden');
      $('#controls').style.display = 'flex';
      applySettingsToDOM();
      renderAll();
      toast(`Welcome, ${user}!`);
      save();
    }

    /* ================== RENDERING ================== */
    function renderAll() {
      $('#title').textContent = `Miner Co ‚Äî ${state.player.username}`;
      $('#pickaxeLabel').textContent = state.player.pickaxe;
      $('#silverLabel').textContent = fmt(state.player.silver);

      renderMine();
      renderInventory();
      renderShop();
      renderPowerups();
      renderPets();
      renderGear();
      renderLeaderboard();
      renderAchievements();
      renderSettings();
      updatePowerupUI();
      updateDailyButton();
    }

    function renderMine() {
      const wrap = document.createElement('div');
      wrap.className = 'mine-grid';
      const n = state.player.mineSize || 24;
      for (let i=0;i<n;i++) {
        const ore = rollOre();
        const div = document.createElement('button');
        div.type = 'button';
        div.className = `ore ${ore} shine`;
        div.dataset.ore = ore;
        div.setAttribute('aria-label', `Mine ${ore}`);
        div.innerHTML = `${icon(ore)} ${label(ore)}<span class="sub">tap to mine</span>`;
        if (!canMine(ore)) { const need = ORE_REQUIREMENTS[ore]; const lock = document.createElement('span'); lock.className = 'lock'; lock.textContent = `üîí ${need}`; div.appendChild(lock); }
        div.addEventListener('click', onMineTile);
        wrap.appendChild(div);
      }
      const mount = $('#mine'); mount.innerHTML = ''; mount.appendChild(wrap);
    }

    function renderInventory() {
      const left = $('#inventoryLeft'); left.innerHTML = '';
      const make = (k)=>{ const pill = document.createElement('div'); pill.className = 'pill'; pill.innerHTML = `${icon(k)} <span class="muted">${k}:</span> <b>${fmt(state.player.inventory[k]||0)}</b>`; return pill; };
      ORES.filter(k=> k!== 'goldrush').forEach(k=> left.appendChild(make(k)));
      const silverPill = document.createElement('div'); silverPill.className = 'pill'; silverPill.innerHTML = `ü™ô <span class="muted">silver:</span> <b>${fmt(state.player.silver)}</b>`; left.appendChild(silverPill);
    }

    function renderShop() {
      const grid = $('#shopGrid'); grid.innerHTML = '';
      Object.keys(PICKAXE_COSTS).forEach(tier=>{ const cost = PICKAXE_COSTS[tier]; const card = document.createElement('div'); card.className = 'card'; const afford = canAfford(cost); const owned = (tierIndex(state.player.pickaxe) >= tierIndex(tier)); card.innerHTML = `<h4 style="margin:0 0 6px">${icon('pickaxe')} ${titleCase(tier)} Pickaxe</h4><div class="muted" style="margin-bottom:8px">Cost: ${costList(cost)}</div><button ${owned? 'disabled':''} ${!afford||owned? 'class=\"btn-ghost\"':''} data-tier="${tier}">${owned? 'Owned' : (afford? 'Buy' : 'Need more')}</button>`; const btn = card.querySelector('button'); btn.addEventListener('click', ()=> buyPickaxe(tier)); grid.appendChild(card); });
    }

    function renderPowerups() {
      const grid = $('#powerupGrid'); grid.innerHTML = '';
      Object.entries(POWERUP_SHOP).forEach(([name, price])=>{ const card = document.createElement('div'); card.className = 'card'; const active = isActive(POWERUP_EFFECTS[name].key); card.innerHTML = `<h4 style=\"margin:0 0 6px\">${icon('bolt')} ${name}</h4><div class=\"muted\" style=\"margin-bottom:8px\">${active? 'Active' : `Price: ${fmt(price)} silver`}</div><button ${active? 'disabled':''} ${state.player.silver<price?'class=\"btn-ghost\"':''} data-pwr="${name}">${active? 'Running' : 'Purchase'}</button>`; card.querySelector('button').addEventListener('click', ()=> buyPowerup(name)); grid.appendChild(card); });
    }

    function renderPets() {
      const owned = $('#petsOwned'); owned.innerHTML = '';
      if (!state.player.pets.length) { owned.innerHTML = `<div class="card muted">No pets yet. Try a spin!</div>`; return; }
      state.player.pets.forEach(p=>{ const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<h4 style="margin:0 0 6px">${icon('pet')} ${p.name} <span class="muted">(${p.rarity})</span></h4><div class="muted">${describePet(p)}</div>`; owned.appendChild(card); });
    }

    function renderGear() {
      const grid = $('#gearGrid'); grid.innerHTML = '';
      SWORDS.forEach(s=>{ const owned = (state.player.sword === s.id); const can = state.player.silver >= (s.price||0); const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<h4 style=\"margin:0 0 6px\">${icon('sword')} ${s.name}</h4><div class=\"muted\" style=\"margin-bottom:8px\">Crit: ${s.crit}% ${s.price? `¬∑ Price: ${fmt(s.price)} silver` : ''}</div><button ${owned?'disabled':''} ${!owned && !can ? 'class=\"btn-ghost\"':''}>${owned? 'Equipped' : (s.price? 'Buy' : 'Default')}</button>`; card.querySelector('button').addEventListener('click', ()=> buySword(s)); grid.appendChild(card); });
    }

    function renderLeaderboard() {
      const ul = $('#leaderboardList'); loadUsers(); const arr = Object.values(state.users); arr.sort((a,b)=> (b?.silver||0) - (a?.silver||0)); ul.innerHTML = arr.slice(0,10).map((u,i)=>{ const you = u.username === state.player.username ? ' (you)' : ''; return `<li>${i+1}. <b>${u.username}</b> ‚Äî ${fmt(u.silver||0)} silver${you}</li>`; }).join('');
    }

    function renderAchievements() {
      const ul = $('#achievementsList');
      ul.innerHTML = ACHIEVEMENTS.map(a=>{
        const done = state.player.achievementsUnlocked.includes(a.id);
        return `<li class="card" style="display:flex; justify-content:space-between; align-items:center"><div><b>${a.name}</b><div class="muted">${done? 'Completed' : 'Locked'}</div></div><div>${done? '‚úÖ' : 'üîí'}</div></li>`;
      }).join('');
    }

    function renderSettings() {
      $('#toggleSfxBtn').textContent = (state.player.settings.sfx? 'üîä SFX On' : 'üîá SFX Off');
      $('#toggleMotionBtn').textContent = (state.player.settings.reducedMotion? 'üõë Motion Off' : 'üéûÔ∏è Motion On');
      $('#toggleAutosellBtn').textContent = (state.player.settings.autosell? 'üí∏ Autosell: On' : 'üí∞ Autosell: Off');
      $('#particleRange').value = state.player.settings.particles;
      $('#particleVal').textContent = state.player.settings.particles.toFixed(2);
    }

    function updatePowerupUI() {
      const parts = [];
      const bars = [];
      for (const [key, p] of Object.entries(state.player.activePowerups)) {
        if (!p.until || p.until<=now()) continue;
        const remaining = Math.max(0, p.until - now());
        const secs = Math.ceil(remaining/1000);
        const pct = Math.max(0, Math.min(100, 100*remaining/(POWERUP_EFFECTS[key==='strength'? '2x Strength':'2x Luck'].secs*1000)));
        parts.push(`${titleCase(key)} ${p.mult}x (${secs}s)`);
        bars.push(`<div class="bar" title="${titleCase(key)}"><div class="bar-fill" style="width:${pct}%"></div></div>`);
      }
      $('#powerupLabel').textContent = parts.length? parts.join(' ¬∑ ') : 'none';
      $('#powerupBars').innerHTML = bars.join('');
    }

    /* ================== LOGIC ================== */
    function toggleMenu(id) { $$('.menu').forEach(m=>{ if (m.id === id) { const isOpen = m.classList.contains('show'); if (isOpen) { m.classList.remove('show'); m.classList.add('hide'); setTimeout(()=> m.classList.remove('hide'), 210); } else { m.classList.add('show'); } } else { if (m.classList.contains('show')) { m.classList.remove('show'); m.classList.add('hide'); setTimeout(()=> m.classList.remove('hide'), 210); } } }); }

    function canMine(ore) { return tierIndex(state.player.pickaxe) >= tierIndex(ORE_REQUIREMENTS[ore]); }

    function onMineTile(e) {
      const el = e.currentTarget; const ore = el.dataset.ore; const rect = el.getBoundingClientRect(); const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
      if (!canMine(ore)) { floatingText('üîí', cx, cy); return; }

      if (state.player.settings.sfx) { try { $('#mineSound').currentTime = 0; $('#mineSound').play().catch(()=>{}); } catch(_){} }

      // Yield
      let amount = Math.max(1, Math.floor(1 * powerMult('strength')));
      let isCrit = false;
      if (Math.random()*100 < critChance()) { amount *= 2; isCrit = true; floatingText('CRIT ‚ú®', cx, cy-10); state.player.stats.crits++; }

      // Award inventory & stats
      if (ore === 'rainbow') {
        const bonus = ORES.slice(0,7)[Math.floor(Math.random()*7)];
        addOre(bonus, amount);
        floatingText(`+${amount} ${bonus} üåà`, cx, cy);
      } else if (ore === 'goldrush') {
        addOre('gold', amount*2);
        floatingText(`+${amount*2} gold üü°`, cx, cy);
      } else {
        addOre(ore, amount);
        floatingText(`+${amount} ${ore}`, cx, cy);
      }
      state.player.stats.oresMined += amount;

      // Autosell commons
      if (state.player.settings.autosell) {
        const commons = ['coal','copper','bronze'];
        for (const c of commons) {
          const qty = state.player.inventory[c]||0; if (!qty) continue;
          const gain = Math.floor(qty * ORE_VALUES[c] * sellMult());
          if (gain>0) {
            state.player.inventory[c] = 0; state.player.silver += gain; state.player.stats.silverEarned += gain;
            floatingText(`üí∏ +${fmt(gain)}`, cx+Math.random()*20-10, cy-14);
          }
        }
      }

      // Visuals
      particles(cx, cy, oreColor(ore), isCrit? 1.5 : 1);
      if (ore === 'diamond' || ore === 'emerald') confetti(cx, cy);

      // Reroll tile
      const next = rollOre(); el.className = `ore ${next} shine`; el.dataset.ore = next; el.innerHTML = `${icon(next)} ${label(next)}<span class="sub">tap to mine</span>`; if (!canMine(next)) { const need = ORE_REQUIREMENTS[next]; const lock = document.createElement('span'); lock.className = 'lock'; lock.textContent = `üîí ${need}`; el.appendChild(lock); }

      renderInventory(); $('#silverLabel').textContent = fmt(state.player.silver);
      checkAchievements(); save();
    }

    function addOre(ore, qty) { state.player.inventory[ore] = (state.player.inventory[ore]||0) + qty; if (state.player.stats.total[ore] !== undefined) state.player.stats.total[ore] += qty; }

    function oreColor(ore) { const map = { coal:'#8b8b8b', copper:'#d97706', bronze:'#ca8a04', silver:'#a7aab2', gold:'#f59e0b', diamond:'#60a5fa', emerald:'#10b981', rainbow:'#e879f9', goldrush:'#eab308' }; return map[ore]||'#fff'; }

    function baseWeights() { return { coal:40, copper:24, bronze:14, silver:10, gold:6, diamond:4, emerald:2, rainbow:0.6, goldrush:0 }; }

    function rollOre() {
      const w = baseWeights();
      const pi = tierIndex(state.player.pickaxe); if (pi>=3) { w.silver += 2; w.gold += 1; } if (pi>=4) { w.gold += 2; w.diamond += 1; } if (pi>=5) { w.diamond += 2; w.emerald += 1; }
      const luck = powerMult('luck'); if (luck>1) { w.diamond *= luck; w.emerald *= luck; w.rainbow *= Math.max(1, luck*0.9); }
      if (state.event && state.event.until>now()) { if (state.event.type==='gold') { w.gold += 10; w.goldrush = 2; } if (state.event.type==='emerald') { w.emerald += 6; } if (state.event.type==='rainbow') { w.rainbow += 2.5; } }
      const entries = Object.entries(w); const total = entries.reduce((a,[,v])=> a+v, 0); let r = Math.random()*total; for (const [k,v] of entries) { if ((r-=v)<=0) return k; } return 'coal';
    }

    function canAfford(cost) { return Object.entries(cost).every(([k,v])=> (state.player.inventory[k]||0) >= v); }
    function costList(cost) { return Object.entries(cost).map(([k,v])=> `${v} ${k}`).join(', '); }

    function buyPickaxe(tier) {
      const owned = (tierIndex(state.player.pickaxe) >= tierIndex(tier)); if (owned) return;
      const cost = PICKAXE_COSTS[tier]; if (!canAfford(cost)) { toast('Not enough resources'); return; }
      Object.entries(cost).forEach(([k,v])=> state.player.inventory[k]-=v);
      state.player.pickaxe = tier; toast(`Purchased ${titleCase(tier)} pickaxe!`);
      $('#pickaxeLabel').textContent = tier; renderInventory(); renderShop(); checkAchievements(); save();
    }

    function grantPowerup(name, secs=POWERUP_EFFECTS[name].secs) { const eff = POWERUP_EFFECTS[name]; const until = now() + secs*1000; state.player.activePowerups[eff.key] = { mult: eff.mult, until }; updatePowerupUI(); }

    function buyPowerup(name) { const price = POWERUP_SHOP[name]; if (state.player.silver < price) { toast('Need more silver'); return; } state.player.silver -= price; state.player.stats.silverSpent += price; grantPowerup(name); toast(`${name} activated for ${POWERUP_EFFECTS[name].secs}s`); renderPowerups(); $('#silverLabel').textContent = fmt(state.player.silver); save(); }

    function buySword(s) { if (!s.price) { state.player.sword = s.id; toast('Default equipped'); save(); renderGear(); return; } if (state.player.silver < s.price) { toast('Need more silver'); return; } state.player.silver -= s.price; state.player.stats.silverSpent += s.price; state.player.sword = s.id; toast(`${s.name} equipped`); $('#silverLabel').textContent = fmt(state.player.silver); renderGear(); save(); }

    function sellAll() {
      let gain = 0; for (const [ore,val] of Object.entries(ORE_VALUES)) { const qty = state.player.inventory[ore] || 0; if (!qty || ore==='goldrush') continue; gain += qty * val; state.player.inventory[ore] = 0; }
      gain = Math.floor(gain * sellMult()); if (gain<=0) { toast('Nothing to sell'); return; }
      if (state.player.settings.sfx) { try { $('#munchSound').currentTime=0; $('#munchSound').play().catch(()=>{});} catch(_){} }
      state.player.silver += gain; state.player.stats.silverEarned += gain; toast(`Sold all for +${fmt(gain)} silver`); renderInventory(); $('#silverLabel').textContent = fmt(state.player.silver); checkAchievements(); save();
    }

    function spinPet() {
      const cost = 150; const free = state._freePetOnce;
      if (state.player.silver < cost && !free) { toast('Need 150 silver'); return; }
      if (!free) { state.player.silver -= cost; state.player.stats.silverSpent += cost; } else delete state._freePetOnce;
      const rarity = weightedPick(PET_WEIGHTS); const candidates = PET_POOL.filter(p=> p.rarity===rarity); const pet = candidates[Math.floor(Math.random()*candidates.length)]; const dup = state.player.pets.find(p=> p.id===pet.id);
      if (dup) { state.player.silver += 50; toast(`Duplicate ${pet.name}. Refunded 50 silver.`); }
      else { state.player.pets.push(pet); toast(`New pet: ${pet.name}!`); }
      $('#petResult').innerHTML = `<div class="card" style="text-align:center"><h3 style="margin:6px 0">${icon('pet')} ${pet.name}</h3><div class="muted">${pet.rarity} ¬∑ ${describePet(pet)}</div></div>`;
      confetti(window.innerWidth/2, 160); $('#silverLabel').textContent = fmt(state.player.silver); renderPets(); save();
    }

    function redeemCode() { const raw = $('#codeInput').value.trim().toUpperCase(); if (!raw) return; if (state.player.usedCodes.includes(raw)) { msgCode('Code already used.'); return; } const fn = CODE_REWARDS[raw]; if (!fn) { msgCode('Invalid code.'); return; } const reward = fn(state.player); if (reward.silver) state.player.silver += reward.silver; if (reward.item) Object.entries(reward.item).forEach(([k,v])=> addOre(k,v)); if (reward.powerup) grantPowerup(reward.powerup); if (reward.freepet) state._freePetOnce = true; if (reward.event) spawnEvent(reward.event, true); state.player.usedCodes.push(raw); msgCode(`‚úÖ ${reward.message}`); $('#silverLabel').textContent = fmt(state.player.silver); renderInventory(); checkAchievements(); save(); }
    function msgCode(text){ $('#codeMessage').textContent = text; }

    function adminLogin() { const code = $('#adminCode').value.trim(); if (code === 'letmein') { $('#adminControls').classList.remove('hidden'); toast('Admin unlocked'); } else toast('Wrong admin code'); }
    function giveMoney() { state.player.silver += 999999; state.player.stats.silverEarned += 999999; toast('Cha-ching! +999,999 silver'); $('#silverLabel').textContent = fmt(state.player.silver); save(); }
    function givePowerups() { const until = now()+10*60*1000; state.player.activePowerups.strength = { mult:2, until }; state.player.activePowerups.luck = { mult:2, until }; toast('All powerups for 10 minutes'); updatePowerupUI(); save(); }

    function spawnEvent(type, silent=false) { const mins = 3; state.event = { type, until: now()+mins*60*1000 }; const banner = document.createElement('div'); banner.className = 'banner'; banner.textContent = (type==='gold')? 'üü° GOLD RUSH! Gold spawns boosted.' : (type==='emerald')? 'üíö EMERALD EVENT! Emeralds boosted.' : 'üåà RAINBOW ORES!'; const mount = $('#eventBanner'); mount.innerHTML=''; mount.appendChild(banner); mount.style.display = 'block'; setTimeout(()=> { if (state.event && state.event.until<=now()) { mount.style.display='none'; mount.innerHTML=''; } }, mins*60*1000); if (!silent) toast('Event started'); }

    function logout() { $('#controls').style.display = 'none'; $('#login-container').classList.remove('hidden'); $('#codeMessage').textContent = ''; toast('Logged out'); }

    /* ================== ACHIEVEMENTS / DAILY ================== */
    function checkAchievements() {
      let any = false;
      for (const a of ACHIEVEMENTS) {
        if (state.player.achievementsUnlocked.includes(a.id)) continue;
        if (a.cond(state.player)) { state.player.achievementsUnlocked.push(a.id); any = true; if (a.reward.silver) { state.player.silver += a.reward.silver; state.player.stats.silverEarned += a.reward.silver; } if (a.reward.powerup) grantPowerup(a.reward.powerup); toast(`üèÖ Achievement: ${a.name}`); confetti(window.innerWidth/2, 80); }
      }
      if (any) { renderAchievements(); $('#silverLabel').textContent = fmt(state.player.silver); }
    }

    function canClaimDaily() { return !state.player.lastDaily || (now() - state.player.lastDaily) >= 24*60*60*1000; }
    function updateDailyButton() { const btn = $('#dailyBtn'); btn.disabled = !canClaimDaily(); btn.className = canClaimDaily()? 'btn' : 'btn-ghost'; btn.title = canClaimDaily()? 'Claim your daily reward (D)' : 'Daily cooldown active'; }
    function claimDaily() { if (!canClaimDaily()) return; state.player.lastDaily = now(); const silver = 200; state.player.silver += silver; state.player.stats.silverEarned += silver; grantPowerup(Math.random()<0.5? '2x Strength':'2x Luck', 60); toast(`üéÅ Daily: +${silver} silver & powerup (60s)`); confetti(window.innerWidth/2, 120); $('#silverLabel').textContent = fmt(state.player.silver); updateDailyButton(); save(); }

    /* ================== SETTINGS / SAVE I/O ================== */
    function applySettingsToDOM() {
      document.documentElement.setAttribute('data-motion', state.player.settings.reducedMotion? 'off' : 'on');
      $('#mineSound').muted = $('#munchSound').muted = !state.player.settings.sfx;
    }

    $('#toggleSfxBtn')?.addEventListener('click', ()=>{ state.player.settings.sfx = !state.player.settings.sfx; applySettingsToDOM(); renderSettings(); save(); });
    $('#toggleMotionBtn')?.addEventListener('click', ()=>{ state.player.settings.reducedMotion = !state.player.settings.reducedMotion; applySettingsToDOM(); renderSettings(); save(); });
    $('#toggleAutosellBtn')?.addEventListener('click', ()=>{ state.player.settings.autosell = !state.player.settings.autosell; renderSettings(); save(); });
    $('#particleRange')?.addEventListener('input', (e)=>{ state.player.settings.particles = parseFloat(e.target.value); $('#particleVal').textContent = state.player.settings.particles.toFixed(2); save(); });

    function exportSave() { const data = JSON.stringify(state.player, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${state.player.username||'minerco-save'}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('Save exported'); }
    function copySave() { navigator.clipboard?.writeText(JSON.stringify(state.player)).then(()=> toast('Save copied to clipboard')); }
    function importSave(file) { const reader = new FileReader(); reader.onload = ()=>{ try { const obj = JSON.parse(reader.result); if (!obj || typeof obj !== 'object') throw new Error('Invalid'); state.player = { ...DEFAULT_PLAYER(), ...obj, settings: { ...DEFAULT_PLAYER().settings, ...(obj.settings||{}) }, stats: { ...DEFAULT_PLAYER().stats, ...(obj.stats||{}), total: { ...DEFAULT_PLAYER().stats.total, ...(obj.stats?.total||{}) } } }; save(); toast('Save imported'); applySettingsToDOM(); renderAll(); } catch(e){ alert('Import failed'); } }; reader.readAsText(file); }

    /* ================== HELPERS ================== */
    function titleCase(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
    function icon(k) { switch(k){ case 'coal': return 'ü™®'; case 'copper': return 'ü•â'; case 'bronze': return 'üü§'; case 'silver': return 'ü•à'; case 'gold': return 'ü•á'; case 'diamond': return 'üíé'; case 'emerald': return 'üíö'; case 'rainbow': return 'üåà'; case 'goldrush': return 'üü°'; case 'pickaxe': return '‚õèÔ∏è'; case 'bolt': return '‚ö°'; case 'sword': return '‚öîÔ∏è'; case 'pet': return 'üêæ'; default: return '‚õèÔ∏è'; } }
    const label = ore => titleCase(ore);
    function weightedPick(weights) { const entries = Object.entries(weights); const total = entries.reduce((a,[,v])=> a+v, 0); let r = Math.random()*total; for (const [key, w] of entries) { if ((r-=w) <= 0) return key; } return entries[0][0]; }
    function describePet(p) { if (p.effect.strength) return `+${Math.round((p.effect.strength-1)*100)}% ore yield`; if (p.effect.luck) return `+${Math.round((p.effect.luck-1)*100)}% luck`; if (p.effect.sell) return `+${Math.round((p.effect.sell-1)*100)}% sell value`; if (p.effect.crit) return `+${Math.round(p.effect.crit*100)}% crit chance`; return 'Loyal companion'; }

    /* ================== TIMERS ================== */
    setInterval(()=>{ updatePowerupUI(); if (state.event && state.event.until<=now()) { state.event=null; $('#eventBanner').style.display='none'; $('#eventBanner').innerHTML=''; } }, 1000);

    /* ================== EVENTS ================== */
    $('#loginBtn').addEventListener('click', login);
    $('#sellAllBtn').addEventListener('click', sellAll);
    $('#spinPetBtn').addEventListener('click', spinPet);
    $('#redeemBtn').addEventListener('click', redeemCode);
    $('#adminLoginBtn').addEventListener('click', adminLogin);
    $('#logoutBtn').addEventListener('click', logout);
    $('#dailyBtn').addEventListener('click', claimDaily);

    $('#exportBtn')?.addEventListener('click', exportSave);
    $('#copyBtn')?.addEventListener('click', copySave);
    $('#importFile')?.addEventListener('change', (e)=> e.target.files[0] && importSave(e.target.files[0]));

    // Hotkeys
    document.addEventListener('keydown', (e)=>{
      if ($('#login-container') && !$('#login-container').classList.contains('hidden')) return;
      if (e.target.matches('input, textarea')) return;
      const map = { '1':'shopMenu','2':'powerupMenu','3':'petShopMenu','4':'gearShopMenu','5':'codeMenu','6':'adminMenu','7':'leaderboardMenu','8':'achievementsMenu','9':'settingsMenu' };
      if (map[e.key]) toggleMenu(map[e.key]);
      if (e.key==='x' || e.key==='X') sellAll();
      if (e.key==='d' || e.key==='D') claimDaily();
    });

    // Start screen focus
    setTimeout(()=> $('#username')?.focus(), 50);
  </script>
</body>
</html>
